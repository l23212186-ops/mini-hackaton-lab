<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventario Lab</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .action-btn { margin-right: 5px; }
    </style>
</head>
<body>
    <div id="navbar-container"></div>

    <div class="container mt-4">
        <h1 class="mb-4">Gesti√≥n de Laboratorio üî¨</h1>
        
        <div class="row mb-3 align-items-center">
            <div class="col-md-4">
                <input type="text" id="live-search" class="form-control" placeholder="üîç Buscar instrumento...">
            </div>
            
            <div class="col-md-8 text-end">
                <button id="btn-new" class="btn btn-success" style="display:none;">+ Nuevo Instrumento</button>
                
                <div id="admin-buttons" class="d-none">
                    <button id="btn-register-user" class="btn btn-warning">üë§ Crear Usuario</button>
                    <button id="btn-view-users" class="btn btn-dark">üë• Ver Usuarios</button>
                </div>

                <button id="btn-download" class="btn btn-secondary">üì• Descargar Excel</button>
                
                <form id="upload-form" class="ms-2" style="display:none;">
                    <input type="file" id="excel-file" name="fileExcel" accept=".xlsx" style="display:none;">
                    <button type="button" class="btn btn-info" onclick="document.getElementById('excel-file').click()">üì§ Subir Excel</button>
                </form>
            </div>
        </div>

        <div class="table-responsive">
            <table class="table table-hover table-bordered align-middle">
                <thead class="table-dark">
                    <tr>
                        <th>#</th> <th>Nombre</th>
                        <th>Categor√≠a</th>
                        <th>Estado</th>
                        <th>Ubicaci√≥n</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="table-body"></tbody>
            </table>
        </div>
    </div>

    <div class="modal fade" id="crudModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="modalTitle">Instrumento</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="crud-form">
                        <input type="hidden" id="inst-id">
                        <div class="mb-3"><label class="form-label">Nombre</label><input type="text" id="nombre" class="form-control" required></div>
                        <div class="mb-3"><label class="form-label">Categor√≠a</label><input type="text" id="categoria" class="form-control" required></div>
                        <div class="mb-3"><label class="form-label">Estado</label>
                            <select id="estado" class="form-select">
                                <option value="DISPONIBLE">DISPONIBLE</option><option value="PRESTADO">PRESTADO</option><option value="MANTENIMIENTO">MANTENIMIENTO</option>
                            </select>
                        </div>
                        <div class="mb-3"><label class="form-label">Ubicaci√≥n</label><input type="text" id="ubicacion" class="form-control"></div>
                        <button type="submit" class="btn btn-primary w-100">Guardar</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="userModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title text-dark">Registrar Nuevo Usuario</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="user-form">
                        <div class="mb-3"><label class="form-label">Nombre</label><input type="text" id="reg-nombre" class="form-control" required></div>
                        <div class="mb-3"><label class="form-label">Correo</label><input type="email" id="reg-correo" class="form-control" required></div>
                        <div class="mb-3"><label class="form-label">Password</label><input type="password" id="reg-password" class="form-control" required></div>
                        <div class="mb-3"><label class="form-label">Rol</label>
                            <select id="reg-rol" class="form-select">
                                <option value="ASISTENTE">ASISTENTE</option><option value="AUDITOR">AUDITOR</option><option value="ADMIN">ADMIN</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-warning w-100">Registrar Usuario</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="usersListModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title">üë• Lista de Usuarios</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <table class="table table-striped align-middle">
                        <thead>
                            <tr>
                                <th>ID</th><th>Nombre</th><th>Correo</th><th>Rol</th><th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body"></tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        let crudModal, userModal, usersListModal;
        const role = localStorage.getItem('userRole');

        document.addEventListener('DOMContentLoaded', () => {
            // 1. Seguridad: Redirigir si no hay rol
            if (!role) { window.location.href = '/login.html'; return; }

            // 2. Cargar Navbar y activar Logout
            fetch('navbar.html')
                .then(r => r.text())
                .then(d => {
                    document.getElementById('navbar-container').innerHTML = d;
                    // Activar el bot√≥n de logout una vez cargado el HTML
                    const btnLogout = document.getElementById('btn-logout');
                    if (btnLogout) {
                        btnLogout.addEventListener('click', async (e) => {
                            e.preventDefault();
                            try {
                                await fetch('/api/auth/logout', { method: 'POST' });
                                localStorage.removeItem('userRole');
                                window.location.href = '/login.html';
                            } catch (error) { console.error(error); }
                        });
                    }
                });
            
            // 3. Inicializar Modales
            crudModal = new bootstrap.Modal(document.getElementById('crudModal'));
            userModal = new bootstrap.Modal(document.getElementById('userModal'));
            usersListModal = new bootstrap.Modal(document.getElementById('usersListModal'));

            loadData();

            // 4. Configurar Visibilidad de Botones
            document.getElementById('btn-new').style.display = 'none';
            document.getElementById('admin-buttons').classList.remove('d-inline-block'); 
            document.getElementById('upload-form').style.display = 'none';

            if (role === 'ADMIN' || role === 'ASISTENTE') {
                document.getElementById('btn-new').style.display = 'inline-block';
            }
            if (role === 'ADMIN') {
                document.getElementById('admin-buttons').classList.remove('d-none');
                document.getElementById('admin-buttons').classList.add('d-inline-block');
                document.getElementById('upload-form').style.display = 'inline-block';
            }

            // 5. Event Listeners
            document.getElementById('btn-new').onclick = () => openInstrumentModal();
            document.getElementById('btn-register-user').onclick = () => userModal.show();
            document.getElementById('btn-view-users').onclick = loadUsers;
            document.getElementById('btn-download').onclick = () => window.location.href = '/api/instrumentos/download';
            document.getElementById('live-search').onkeyup = (e) => loadData(e.target.value);
            
            // Subida de Excel
            document.getElementById('excel-file').onchange = async (e) => {
                if (!e.target.files.length) return;
                const formData = new FormData();
                formData.append('fileExcel', e.target.files[0]);
                try {
                    const res = await fetch('/api/instrumentos/upload', { method:'POST', body: formData });
                    const data = await res.json();
                    if(res.ok) { alert('¬°Cargado! Registros: ' + data.registros); loadData(); } 
                    else { alert('Error: ' + data.error); }
                } catch(err) { alert('Error de conexi√≥n'); }
                e.target.value = '';
            };

            // Formularios
            document.getElementById('crud-form').onsubmit = saveInstrument;
            document.getElementById('user-form').onsubmit = registerUser;
        });

        // --- FUNCIONES DE INSTRUMENTOS ---
        async function loadData(q = '') {
            try {
                const url = q ? `/api/instrumentos/buscar?q=${q}` : '/api/instrumentos';
                const res = await fetch(url);
                if (res.status === 401) { localStorage.removeItem('userRole'); window.location.href = '/login.html'; return; }
                
                const data = await res.json();
                const tbody = document.getElementById('table-body');
                tbody.innerHTML = '';
                
                // Usamos 'index' para el contador visual 1, 2, 3...
                data.forEach((i, index) => {
                    let btns = '';
                    if (role === 'ADMIN' || role === 'ASISTENTE') btns += `<button class="btn btn-sm btn-warning action-btn" onclick='openInstrumentModal(${JSON.stringify(i)})'>‚úèÔ∏è</button>`;
                    if (role === 'ADMIN') btns += `<button class="btn btn-sm btn-danger action-btn" onclick="deleteInst(${i.id})">üóëÔ∏è</button>`;
                    
                    tbody.innerHTML += `
                        <tr>
                            <td>${index + 1}</td> <td>${i.nombre}</td><td>${i.categoria}</td>
                            <td><span class="badge bg-${getStatusColor(i.estado)}">${i.estado}</span></td>
                            <td>${i.ubicacion}</td><td>${btns}</td>
                        </tr>`;
                });
            } catch (error) { console.error(error); }
        }

        // --- FUNCIONES DE USUARIOS ---
        async function loadUsers() {
            try {
                const res = await fetch('/api/usuarios');
                if (!res.ok) return alert('No autorizado');
                const users = await res.json();
                const tbody = document.getElementById('users-table-body');
                tbody.innerHTML = '';

                users.forEach(u => {
                    const deleteBtn = `<button class="btn btn-sm btn-danger" onclick="deleteUser(${u.id})">üóëÔ∏è</button>`;
                    tbody.innerHTML += `
                        <tr>
                            <td>${u.id}</td><td>${u.nombre}</td><td>${u.correo}</td>
                            <td><span class="badge bg-info text-dark">${u.rol}</span></td>
                            <td>${deleteBtn}</td>
                        </tr>`;
                });
                usersListModal.show();
            } catch (error) { alert('Error cargando usuarios'); }
        }

        async function deleteUser(id) {
            if(!confirm('¬øEst√°s seguro de eliminar a este usuario?')) return;
            try {
                const res = await fetch(`/api/usuarios/${id}`, { method: 'DELETE' });
                const data = await res.json();
                if (res.ok) { alert('Usuario eliminado'); loadUsers(); } 
                else { alert('Error: ' + data.error); }
            } catch (err) { alert('Error de conexi√≥n'); }
        }

        // --- L√ìGICA DEL CRUD ---
        function openInstrumentModal(data = null) {
            document.getElementById('modalTitle').innerText = data ? 'Editar Instrumento' : 'Nuevo Instrumento';
            document.getElementById('inst-id').value = data ? data.id : '';
            document.getElementById('nombre').value = data ? data.nombre : '';
            document.getElementById('categoria').value = data ? data.categoria : '';
            document.getElementById('estado').value = data ? data.estado : 'DISPONIBLE';
            document.getElementById('ubicacion').value = data ? data.ubicacion : '';
            crudModal.show();
        }

        async function saveInstrument(e) {
            e.preventDefault();
            const id = document.getElementById('inst-id').value;
            const body = JSON.stringify({
                nombre: document.getElementById('nombre').value,
                categoria: document.getElementById('categoria').value,
                estado: document.getElementById('estado').value,
                ubicacion: document.getElementById('ubicacion').value
            });
            const res = await fetch(id ? `/api/instrumentos/${id}` : '/api/instrumentos', {
                method: id ? 'PUT' : 'POST', headers: {'Content-Type': 'application/json'}, body
            });
            if(res.ok) { crudModal.hide(); loadData(); } else alert('Error');
        }

        async function deleteInst(id) {
            if(!confirm('¬øBorrar?')) return;
            const res = await fetch(`/api/instrumentos/${id}`, { method: 'DELETE' });
            if(res.ok) loadData();
        }

        async function registerUser(e) {
            e.preventDefault();
            const body = JSON.stringify({
                nombre: document.getElementById('reg-nombre').value,
                correo: document.getElementById('reg-correo').value,
                password: document.getElementById('reg-password').value,
                rol: document.getElementById('reg-rol').value
            });
            const res = await fetch('/api/auth/register', {
                method: 'POST', headers: {'Content-Type': 'application/json'}, body
            });
            const data = await res.json();
            if (res.ok) { alert('Registrado'); userModal.hide(); document.getElementById('user-form').reset(); } 
            else { alert('Error: ' + data.error); }
        }

        function getStatusColor(estado) {
            return estado === 'DISPONIBLE' ? 'success' : (estado === 'PRESTADO' ? 'warning' : 'danger');
        }
    </script>
</body>
</html>