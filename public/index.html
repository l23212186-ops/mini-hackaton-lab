<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Inventario Lab</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div id="navbar-container"></div>

    <div class="container mt-4">
        <h1>Gesti√≥n de Laboratorio üî¨</h1>
        
        <div class="row mb-3 mt-4">
            <div class="col-md-4">
                <input type="text" id="live-search" class="form-control" placeholder="üîç Buscar instrumento...">
            </div>
            <div class="col-md-8 text-end">
                <button id="btn-new" class="btn btn-success" style="display:none;">+ Nuevo</button>
                <button id="btn-download" class="btn btn-secondary">üì• Descargar Excel</button>
                
                <form id="upload-form" class="d-inline-block ms-2" style="display:none;">
                    <input type="file" id="excel-file" name="fileExcel" accept=".xlsx" style="display:none;">
                    <button type="button" class="btn btn-info" onclick="document.getElementById('excel-file').click()">üì§ Subir Excel</button>
                </form>
            </div>
        </div>

        <table class="table table-hover table-bordered">
            <thead class="table-dark">
                <tr>
                    <th>ID</th><th>Nombre</th><th>Categor√≠a</th><th>Estado</th><th>Ubicaci√≥n</th><th>Acciones</th>
                </tr>
            </thead>
            <tbody id="table-body"></tbody>
        </table>
    </div>

    <div class="modal fade" id="crudModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="modalTitle">Instrumento</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="crud-form">
                        <input type="hidden" id="inst-id">
                        <div class="mb-2"><label>Nombre</label><input type="text" id="nombre" class="form-control" required></div>
                        <div class="mb-2"><label>Categor√≠a</label><input type="text" id="categoria" class="form-control" required></div>
                        <div class="mb-2"><label>Estado</label>
                            <select id="estado" class="form-select">
                                <option>DISPONIBLE</option><option>PRESTADO</option><option>MANTENIMIENTO</option>
                            </select>
                        </div>
                        <div class="mb-2"><label>Ubicaci√≥n</label><input type="text" id="ubicacion" class="form-control"></div>
                        <button type="submit" class="btn btn-primary w-100 mt-3">Guardar</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let crudModal;
        const role = localStorage.getItem('userRole');

        document.addEventListener('DOMContentLoaded', () => {
            if (!role) window.location.href = '/login.html';
            
            // Cargar Navbar
            fetch('navbar.html').then(r => r.text()).then(d => document.getElementById('navbar-container').innerHTML = d);
            
            crudModal = new bootstrap.Modal(document.getElementById('crudModal'));
            loadData();

            // Configurar botones seg√∫n rol
            if (role === 'ADMIN' || role === 'ASISTENTE') {
                document.getElementById('btn-new').style.display = 'inline-block';
            }
            if (role === 'ADMIN') {
                document.getElementById('upload-form').style.display = 'inline-block';
            }

            // Listeners
            document.getElementById('btn-new').onclick = () => openModal();
            document.getElementById('crud-form').onsubmit = saveInstrument;
            document.getElementById('live-search').onkeyup = (e) => loadData(e.target.value);
            document.getElementById('btn-download').onclick = () => window.location.href = '/api/instrumentos/download';
            
            // Subir Excel autom√°tico al seleccionar archivo
            document.getElementById('excel-file').onchange = async (e) => {
                const formData = new FormData();
                formData.append('fileExcel', e.target.files[0]);
                const res = await fetch('/api/instrumentos/upload', { method:'POST', body: formData });
                if(res.ok) { alert('Cargado'); loadData(); } else alert('Error');
            };
        });

        async function loadData(q = '') {
            const res = await fetch(q ? `/api/instrumentos/buscar?q=${q}` : '/api/instrumentos');
            const data = await res.json();
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';
            
            data.forEach(i => {
                let btns = '';
                if (role === 'ADMIN' || role === 'ASISTENTE') {
                    btns += `<button class="btn btn-sm btn-warning me-1" onclick='openModal(${JSON.stringify(i)})'>‚úèÔ∏è</button>`;
                }
                if (role === 'ADMIN') {
                    btns += `<button class="btn btn-sm btn-danger" onclick="deleteInst(${i.id})">üóëÔ∏è</button>`;
                }
                
                tbody.innerHTML += `
                    <tr>
                        <td>${i.id}</td><td>${i.nombre}</td><td>${i.categoria}</td>
                        <td><span class="badge bg-${i.estado==='DISPONIBLE'?'success':'warning'}">${i.estado}</span></td>
                        <td>${i.ubicacion}</td><td>${btns}</td>
                    </tr>`;
            });
        }

        function openModal(data = null) {
            document.getElementById('modalTitle').innerText = data ? 'Editar Instrumento' : 'Nuevo Instrumento';
            document.getElementById('inst-id').value = data ? data.id : '';
            document.getElementById('nombre').value = data ? data.nombre : '';
            document.getElementById('categoria').value = data ? data.categoria : '';
            document.getElementById('estado').value = data ? data.estado : 'DISPONIBLE';
            document.getElementById('ubicacion').value = data ? data.ubicacion : '';
            crudModal.show();
        }

        async function saveInstrument(e) {
            e.preventDefault();
            const id = document.getElementById('inst-id').value;
            const body = JSON.stringify({
                nombre: document.getElementById('nombre').value,
                categoria: document.getElementById('categoria').value,
                estado: document.getElementById('estado').value,
                ubicacion: document.getElementById('ubicacion').value
            });

            const res = await fetch(id ? `/api/instrumentos/${id}` : '/api/instrumentos', {
                method: id ? 'PUT' : 'POST',
                headers: {'Content-Type': 'application/json'},
                body
            });

            if(res.ok) { crudModal.hide(); loadData(); } else alert('Error al guardar');
        }

        async function deleteInst(id) {
            if(!confirm('¬øBorrar?')) return;
            const res = await fetch(`/api/instrumentos/${id}`, { method: 'DELETE' });
            if(res.ok) loadData();
        }
    </script>
</body>
</html>