<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventario Lab</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style> .action-btn { margin-right: 5px; } </style>
</head>
<body>
    <div id="navbar-container"></div>

    <div class="container mt-4">
        <h1 class="mb-4">Gesti√≥n de Laboratorio üî¨</h1>
        
        <div class="row mb-3 align-items-center">
            <div class="col-md-4">
                <input type="text" id="live-search" class="form-control" placeholder="üîç Buscar instrumento...">
            </div>
            
            <div class="col-md-8 text-end">
                <button id="btn-new" class="btn btn-success" style="display:none;">+ Nuevo Instrumento</button>
                
                <div id="admin-buttons" class="d-none">
                    <button id="btn-register-user" class="btn btn-warning">üë§ Crear Usuario</button>
                    <button id="btn-view-users" class="btn btn-dark">üë• Ver Usuarios</button>
                </div>

                <button id="btn-download" class="btn btn-secondary">üì• Descargar Excel</button>
                
                <form id="upload-form" class="ms-2" style="display:none;">
                    <input type="file" id="excel-file" name="fileExcel" accept=".xlsx" style="display:none;">
                    <button type="button" class="btn btn-info" onclick="document.getElementById('excel-file').click()">üì§ Subir Excel</button>
                </form>
            </div>
        </div>

        <div class="table-responsive">
            <table class="table table-hover table-bordered align-middle">
                <thead class="table-dark">
                    <tr><th>#</th><th>Nombre</th><th>Categor√≠a</th><th>Estado</th><th>Ubicaci√≥n</th><th>Acciones</th></tr>
                </thead>
                <tbody id="table-body"></tbody>
            </table>
        </div>
    </div>

    <div class="modal fade" id="crudModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="modalTitle">Instrumento</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="crud-form">
                        <input type="hidden" id="inst-id">
                        <div class="mb-3"><label>Nombre</label><input type="text" id="nombre" class="form-control" required></div>
                        <div class="mb-3"><label>Categor√≠a</label><input type="text" id="categoria" class="form-control" required></div>
                        <div class="mb-3"><label>Estado</label>
                            <select id="estado" class="form-select">
                                <option>DISPONIBLE</option><option>PRESTADO</option><option>MANTENIMIENTO</option>
                            </select>
                        </div>
                        <div class="mb-3"><label>Ubicaci√≥n</label><input type="text" id="ubicacion" class="form-control"></div>
                        <button type="submit" class="btn btn-primary w-100">Guardar</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="userModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title text-dark" id="userModalTitle">Gesti√≥n de Usuario</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="user-form">
                        <input type="hidden" id="user-id"> <div class="mb-3"><label>Nombre Completo</label><input type="text" id="reg-nombre" class="form-control" required></div>
                        <div class="mb-3"><label>Correo</label><input type="email" id="reg-correo" class="form-control" required></div>
                        <div class="mb-3">
                            <label>Contrase√±a</label>
                            <input type="password" id="reg-password" class="form-control" placeholder="(Dejar vac√≠o si no se cambia)">
                        </div>
                        <div class="mb-3"><label>Rol</label>
                            <select id="reg-rol" class="form-select">
                                <option value="ASISTENTE">ASISTENTE</option><option value="AUDITOR">AUDITOR</option><option value="ADMIN">ADMIN</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-warning w-100">Guardar Usuario</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="usersListModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title">üë• Lista de Usuarios</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <table class="table table-striped align-middle">
                        <thead><tr><th>ID</th><th>Nombre</th><th>Correo</th><th>Rol</th><th>Acciones</th></tr></thead>
                        <tbody id="users-table-body"></tbody>
                    </table>
                </div>
                <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let crudModal, userModal, usersListModal;
        const role = localStorage.getItem('userRole');

        document.addEventListener('DOMContentLoaded', () => {
            if (!role) { window.location.href = '/login.html'; return; }

            fetch('navbar.html').then(r => r.text()).then(d => {
                document.getElementById('navbar-container').innerHTML = d;
                const btnLogout = document.getElementById('btn-logout');
                if(btnLogout) btnLogout.onclick = async () => {
                    await fetch('/api/auth/logout', {method:'POST'});
                    localStorage.removeItem('userRole'); window.location.href='/login.html';
                };
            });

            crudModal = new bootstrap.Modal(document.getElementById('crudModal'));
            userModal = new bootstrap.Modal(document.getElementById('userModal'));
            usersListModal = new bootstrap.Modal(document.getElementById('usersListModal'));

            loadData();

            document.getElementById('btn-new').style.display = 'none';
            document.getElementById('admin-buttons').classList.remove('d-inline-block'); 
            document.getElementById('upload-form').style.display = 'none';

            if (role === 'ADMIN' || role === 'ASISTENTE') document.getElementById('btn-new').style.display = 'inline-block';
            if (role === 'ADMIN') {
                document.getElementById('admin-buttons').classList.remove('d-none');
                document.getElementById('admin-buttons').classList.add('d-inline-block');
                document.getElementById('upload-form').style.display = 'inline-block';
            }

            document.getElementById('btn-new').onclick = () => openInstrumentModal();
            document.getElementById('btn-register-user').onclick = () => openUserModal(); // Crear Nuevo
            document.getElementById('btn-view-users').onclick = loadUsers;
            document.getElementById('btn-download').onclick = () => window.location.href = '/api/instrumentos/download';
            document.getElementById('live-search').onkeyup = (e) => loadData(e.target.value);
            
            document.getElementById('excel-file').onchange = async (e) => {
                if (!e.target.files.length) return;
                const formData = new FormData(); formData.append('fileExcel', e.target.files[0]);
                const res = await fetch('/api/instrumentos/upload', { method:'POST', body: formData });
                if(res.ok) { alert('Cargado'); loadData(); } else alert('Error al cargar');
                e.target.value = '';
            };

            document.getElementById('crud-form').onsubmit = saveInstrument;
            document.getElementById('user-form').onsubmit = saveUser; // Usamos saveUser para ambos
        });

        async function loadData(q = '') {
            const res = await fetch(q ? `/api/instrumentos/buscar?q=${q}` : '/api/instrumentos');
            if (res.status === 401) { localStorage.removeItem('userRole'); window.location.href = '/login.html'; return; }
            const data = await res.json();
            const tbody = document.getElementById('table-body'); tbody.innerHTML = '';
            
            data.forEach((i, idx) => {
                let btns = '';
                if (role === 'ADMIN' || role === 'ASISTENTE') btns += `<button class="btn btn-sm btn-warning action-btn" onclick='openInstrumentModal(${JSON.stringify(i)})'>‚úèÔ∏è</button>`;
                if (role === 'ADMIN') btns += `<button class="btn btn-sm btn-danger action-btn" onclick="deleteInst(${i.id})">üóëÔ∏è</button>`;
                
                tbody.innerHTML += `<tr><td>${idx+1}</td><td>${i.nombre}</td><td>${i.categoria}</td>
                    <td><span class="badge bg-${getStatusColor(i.estado)}">${i.estado}</span></td><td>${i.ubicacion}</td><td>${btns}</td></tr>`;
            });
        }

        async function loadUsers() {
            const res = await fetch('/api/usuarios');
            if (!res.ok) return alert('No autorizado');
            const users = await res.json();
            const tbody = document.getElementById('users-table-body'); tbody.innerHTML = '';
            users.forEach((u, index)=> {
                // Botones Editar y Eliminar
                const btns = `
                    <button class="btn btn-sm btn-warning action-btn" onclick='openUserModal(${JSON.stringify(u)})'>‚úèÔ∏è</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteUser(${u.id})">üóëÔ∏è</button>
                `;
                tbody.innerHTML += `<tr><td>${index+1}</td><td>${u.nombre}</td><td>${u.correo}</td><td><span class="badge bg-info text-dark">${u.rol}</span></td><td>${btns}</td></tr>`;
            });
            usersListModal.show();
        }

        function openInstrumentModal(data = null) {
            document.getElementById('modalTitle').innerText = data ? 'Editar Instrumento' : 'Nuevo Instrumento';
            document.getElementById('inst-id').value = data ? data.id : '';
            document.getElementById('nombre').value = data ? data.nombre : '';
            document.getElementById('categoria').value = data ? data.categoria : '';
            document.getElementById('estado').value = data ? data.estado : 'DISPONIBLE';
            document.getElementById('ubicacion').value = data ? data.ubicacion : '';
            crudModal.show();
        }

        // --- LOGICA UNIFICADA DE USUARIOS (CREAR Y EDITAR) ---
        function openUserModal(data = null) {
            // Si hay data es EDICION, si no es CREACION
            document.getElementById('userModalTitle').innerText = data ? 'Editar Usuario' : 'Registrar Nuevo Usuario';
            document.getElementById('user-id').value = data ? data.id : '';
            document.getElementById('reg-nombre').value = data ? data.nombre : '';
            document.getElementById('reg-correo').value = data ? data.correo : '';
            document.getElementById('reg-rol').value = data ? data.rol : 'ASISTENTE';
            document.getElementById('reg-password').value = ''; // Siempre limpia la contrase√±a
            // En edici√≥n, la contrase√±a no es obligatoria
            document.getElementById('reg-password').required = !data; 
            
            // Si estamos editando, ocultamos la lista y mostramos el form
            if(data) usersListModal.hide();
            userModal.show();
        }

        async function saveUser(e) {
            e.preventDefault();
            const id = document.getElementById('user-id').value;
            const body = JSON.stringify({
                nombre: document.getElementById('reg-nombre').value,
                correo: document.getElementById('reg-correo').value,
                password: document.getElementById('reg-password').value,
                rol: document.getElementById('reg-rol').value
            });

            const method = id ? 'PUT' : 'POST';
            const url = id ? `/api/usuarios/${id}` : '/api/auth/register';

            const res = await fetch(url, { method: method, headers: {'Content-Type': 'application/json'}, body });
            const data = await res.json();

            if (res.ok) {
                alert(id ? 'Usuario actualizado' : 'Usuario registrado');
                userModal.hide();
                if(id) loadUsers(); // Si editamos, recargamos la lista
            } else {
                alert('Error: ' + data.error);
            }
        }

        async function saveInstrument(e) {
            e.preventDefault();
            const id = document.getElementById('inst-id').value;
            const body = JSON.stringify({
                nombre: document.getElementById('nombre').value,
                categoria: document.getElementById('categoria').value,
                estado: document.getElementById('estado').value,
                ubicacion: document.getElementById('ubicacion').value
            });
            const res = await fetch(id ? `/api/instrumentos/${id}` : '/api/instrumentos', {
                method: id ? 'PUT' : 'POST', headers: {'Content-Type': 'application/json'}, body
            });
            if(res.ok) { crudModal.hide(); loadData(); } else alert('Error');
        }

        async function deleteInst(id) {
            if(!confirm('¬øBorrar?')) return;
            const res = await fetch(`/api/instrumentos/${id}`, { method: 'DELETE' });
            if(res.ok) loadData(); else alert('Error al borrar');
        }

        async function deleteUser(id) {
            if(!confirm('¬øEliminar usuario?')) return;
            const res = await fetch(`/api/usuarios/${id}`, { method: 'DELETE' });
            if(res.ok) loadUsers(); else alert('Error al borrar usuario');
        }

        function getStatusColor(s) { return s==='DISPONIBLE'?'success':(s==='PRESTADO'?'warning':'danger'); }
    </script>
</body>
</html>